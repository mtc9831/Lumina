var crypto=require("crypto"),MongoDB=require("mongodb").Db,Server=require("mongodb").Server,moment=require("moment"),dbPort=27017,dbHost="127.0.0.1",dbName="node-login",db=new MongoDB(dbName,new Server(dbHost,dbPort,{auto_reconnect:!0}),{w:1});db.open(function(a,b){a?console.log(a):console.log("connected to database :: "+dbName)});var accounts=db.collection("accounts");exports.autoLogin=function(a,b,d){accounts.findOne({$and:[{user:a},{isActive:!0}]},function(a,e){e?e.pass==b?d(e):d(null):d(null)})};
exports.manualLogin=function(a,b,d){accounts.findOne({$and:[{user:a},{isActive:!0}]},function(a,e){null==e?d("user-not-found"):validatePassword(b,e.pass,function(a,b){b?d(null,e):d("invalid-password")})})};exports.addNewAccount=function(a,b){accounts.findOne({user:a.user},function(d,c){c?b("username-taken"):accounts.findOne({email:a.email},function(d,c){c?b("email-taken"):saltAndHash(a.pass,function(d){a.pass=d;a.date=moment();accounts.insert(a,{safe:!0},b)})})})};
exports.updateAccount=function(a,b){accounts.findOne({user:a.user},function(d,c){c.name=a.name;c.email=a.email;c.contactno=a.contactno;c.country=a.country;c.role=a.role;c.board=a.board;c.standard=a.standard;c.isActive=a.isActive;c.isLocked=a.isLocked;""==a.pass?accounts.save(c,{safe:!0},function(a){a?b(a):b(null,c)}):saltAndHash(a.pass,function(a){c.pass=a;accounts.save(c,{safe:!0},function(a){a?b(a):b(null,c)})})})};
exports.updatePassword=function(a,b,d){accounts.findOne({email:a},function(a,e){a?d(a,null):saltAndHash(b,function(a){e.pass=a;accounts.save(e,{safe:!0},d)})})};exports.ActivateUser=function(a,b,d){accounts.findOne({email:a},function(a,e){a?d(a,null):saltAndHash(b,function(a){e.isActive=!0;accounts.save(e,{safe:!0},d)})})};exports.deleteAccount=function(a,b){accounts.remove({_id:getObjectId(a)},b)};exports.getAccountByEmail=function(a,b){accounts.findOne({email:a},function(a,c){b(c)})};
exports.getAccountByUsername=function(a,b){accounts.findOne({user:a},function(a,c){b(c)})};exports.validateResetLink=function(a,b,d){accounts.find({$and:[{email:a,pass:b}]},function(a,b){d(b?"ok":null)})};exports.getAllRecords=function(a){accounts.find().toArray(function(b,d){b?a(b):a(null,d)})};exports.getRecord=function(a,b){accounts.findOne({_id:getObjectId(a)},function(a,c){a?b(a,null):b(null,c)})};exports.delAllRecords=function(a){accounts.remove({},a)};
var generateSalt=function(){for(var a="",b=0;10>b;b++)var d=Math.floor(64*Math.random()),a=a+"0123456789abcdefghijklmnopqurstuvwxyzABCDEFGHIJKLMNOPQURSTUVWXYZ"[d];return a},md5=function(a){return crypto.createHash("md5").update(a).digest("hex")},saltAndHash=function(a,b){var d=generateSalt();b(d+md5(a+d))},validatePassword=function(a,b,d){var c=b.substr(0,10);a=c+md5(a+c);d(null,b===a)},getObjectId=function(a){return accounts.db.bson_serializer.ObjectID.createFromHexString(a)},findById=function(a,
b){accounts.findOne({_id:getObjectId(a)},function(a,c){a?b(a):b(null,c)})},findByMultipleFields=function(a,b){accounts.find({$or:a}).toArray(function(a,c){a?b(a):b(null,c)})};
