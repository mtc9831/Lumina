var http=require("http"),express=require("express"),formidable=require("formidable"),grid=require("gridfs-stream"),mongoose=require("mongoose"),fs=require("fs"),os=require("os"),path=require("path"),ObjectID=require("mongodb").ObjectID,api_key="key-65537839e609bd6456874e646f05177f",domain="sandbox517084dd6ee74222adf91a15cf140d92.mailgun.org",mailgun=require("mailgun-js")({apiKey:api_key,domain:domain}),CT=require("./modules/country-list"),CITY=require("./modules/city-list"),RL=require("./modules/role-list"),
ST=require("./modules/standard-list"),LN=require("./modules/lang-list"),AM=require("./modules/account-manager"),EM=require("./modules/email-dispatcher"),roleMap=require("./modules/roleMap"),blogController=require("../public/js/controllers/blogController.js"),topicController=require("../public/js/controllers/topicController.js"),feedbackController=require("../public/js/controllers/feedbackController.js"),index=require("../public/js/controllers/index.js");
module.exports=function(c,h){var f=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/locker",limit:"2mb"}),u=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/advjob",limit:"5mb"}),v=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/qpaper",limit:"2mb"}),q=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"/Resources/Assignments/",limit:"10mb"}),r=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/assignmentsoln",
limit:"2mb"}),t=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/workfiles",limit:"10mb"});express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/research",limit:"5mb"});express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/project",limit:"5mb"});express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/literature",limit:"50mb"});express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/resume",limit:"2mb"});
c.get("/signin",f,function(a,b){void 0==a.cookies.user||void 0==a.cookies.pass?(c.set("view engine","jade"),b.render("login",{title:"Hello - Please Login To Your Account"})):AM.autoLogin(a.cookies.user,a.cookies.pass,function(d){null!=d?(a.session.user=d,a.session.role=d.role,c.set("view engine","ejs"),"ToolAdmin"==a.session.role?b.redirect("/toolAdmin"):"ResumeServiceAdmin"==a.session.role?b.redirect("/cvAdmin"):"ResearchAdmin"==a.session.role?b.redirect("/researchAdmin"):"Teacher"==a.session.role||
"Counsellor"==a.session.role?b.redirect("/serviceAdmin"):"Librarian"==a.session.role?b.redirect("/libserviceAdmin"):"Employer"==a.session.role?b.redirect("/employer"):"Marketing"==a.session.role?b.redirect("/marketing"):"Registered Student"==a.session.role||"Star Student"==a.session.role||"Research Student"==a.session.role?b.redirect("/lservices"):"Recruiter"==a.session.role||"Premium Recruiter"==a.session.role?b.redirect("/recruiter"):b.redirect("/signin")):(c.set("view engine","jade"),b.render("login",
{title:"Hello - Please Login To Your Account"}))})});c.post("/signin",f,function(a,b){c.set("view engine","jade");AM.manualLogin(a.param("user"),a.param("pass"),function(c,e){e?(a.session.user=e,a.session.role=e.role,"true"==a.param("remember-me")&&(b.cookie("user",e.user,{maxAge:9E6}),b.cookie("pass",e.pass,{maxAge:9E6}),b.cookie("role",e.role,{maxAge:9E6})),b.send(e,200)):b.send(c,400)})});c.get("/lservices",f,function(a,b){var d=[],e=[];w(a);c.set("view engine","jade");if(null==a.session.user)c.set("view engine",
"jade"),b.redirect("/signin");else if("ToolAdmin"==a.session.role)b.redirect("/toolAdmin");else if("ResumeServiceAdmin"==a.session.role)b.redirect("/cvAdmin");else if("ResearchAdmin"==a.session.role)b.redirect("/researchAdmin");else if("Counsellor"==a.session.role||"Teacher"==a.session.role)b.redirect("/serviceAdmin");else if("Librarian"==a.session.role)b.redirect("/libserviceAdmin");else if("Employer"==a.session.role)b.redirect("/employer");else if("Marketing"==a.session.role)b.redirect("/marketing");
else if("Recruiter"==a.session.role||"Premium Recruiter"==a.session.role)b.redirect("/recruiter");else if("Registered Student"==a.session.role||"Star Student"==a.session.role||"Research Student"==a.session.role)c.set("view engine","ejs"),h.Assoc.find({studygroup:a.session.user.board+a.session.user.standard},function(c,f){if(!c){if(0<f.length){for(var g=f[0].assoc_file,h=f[0].assoc_topic,m=0;m<g.length;m++)d.push(g[m].qFile);for(m=0;m<h.length;m++)e.push(h[m].assoc_topic)}b.render("lservices",{title:"Services",
udata:a.session.user,quizFiles:d,essayTopics:e})}})});c.get("/eservices",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):g(a.session.role,"EARNING_SERVICES")?(c.set("view engine","ejs"),b.render("eservices",{title:"Services",udata:a.session.user})):b.send("Access denied",400)});c.get("/rservices",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):g(a.session.role,"RESEARCH_HOME")?(c.set("view engine","ejs"),b.render("rservices",
{title:"Research",udata:a.session.user})):b.send("Access denied",400)});c.get("/guidedprojects",function(a,b){b.render("guidedprojects")});c.get("/openEssay",function(a,b){h.EssayTopic.count({},function(a,c){if(!a)var f=1+Math.floor(Math.random()*c);h.EssayTopic.find({topicId:f},function(a,c){a?console.log(a):(topic=0!=c.length?c[0].essayTopic:"Error: Could not generate a topic",b.render("openessay",{topic:topic}))})})});c.get("/Resources/Course",function(a,b){c.set("view engine","ejs");var d=a.param("coursename");
"undefined"===typeof d?b.send("Course not found",400):b.render("courses/"+d)});c.get("/writeEssay",function(a,b){c.set("view engine","jade");if(null==a.session.user)b.redirect("/signin");else if(g(a.session.role,"WRITE_ESSAY"))if("undefined"!=typeof a.param("_id"))h.SessionData.findOne({_id:a.param("_id")},function(a,c){b.render("writeEssaySession",{sessionId:c.sessionId,elapsedTime:c.elapsedTime,topic:c.essaycaption,essaytxt:c.essaytxt})});else{var d=a.param("method"),e="";1==d?h.EssayTopic.count({},
function(a,c){if(!a)var f=1+Math.floor(Math.random()*c);h.EssayTopic.find({topicId:f},function(a,c){a?console.log(a):(e=0!=c.length?c[0].essayTopic:"Error: Could not generate a topic",b.render("writeEssay",{topicSelectionMethod:d,topic:e}))})}):b.render("writeEssay",{topicSelectionMethod:a.param("method")})}else b.send("Access denied",400)});c.get("/startThread",f,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):g(a.session.role,"DISCUSSION_THREAD")?b.render("thread",
{udata:a.session.user}):b.send("Access denied",400)});c.get("/viewThreads",f,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):g(a.session.role,"DISCUSSION_THREAD_EXPERT")?b.render("viewThreads",{udata:a.session.user}):b.send("Access denied",400)});c.get("/courseInfoGMAT1",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/courseInfoGMAT1.json","utf8"));b.send(c)});c.get("/courseInfoGMAT2",function(a,
b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/courseInfoGMAT2.json","utf8"));b.send(c)});c.get("/courseInfoGMAT3",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/courseInfoGMAT3.json","utf8"));b.send(c)});c.get("/skillInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/skillInfo.json",
"utf8"));b.send(c)});c.get("/companyInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/companyInfo.json","utf8"));b.send(c)});c.get("/industryInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/industryInfo.json","utf8"));b.send(c)});c.get("/locationInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+
"/../public/vendor/locationInfo.json","utf8"));b.send(c)});c.get("/roleInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/roleInfo.json","utf8"));b.send(c)});c.get("/salaryInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/salaryInfo.json","utf8"));b.send(c)});c.get("/accountsettings",f,function(a,b){c.set("view engine","jade");null==a.session.user?
b.redirect("/signin"):g(a.session.role,"VIEW_SELF_ACCOUNTSETTING")?(c.set("view engine","jade"),b.render("home",{title:"Control Panel",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/accountsettings",f,function(a,b){c.set("view engine","jade");void 0!=a.param("user")?AM.updateAccount({name:a.param("name"),email:a.param("email"),contactno:a.param("contactno"),role:a.param("role"),country:a.param("country"),board:a.param("board"),standard:a.paramm("standard"),user:a.param("user"),
pass:a.param("pass"),isActive:!0,isLocked:!1},function(c,e){c?b.send("error-updating-account",400):(a.session.user=e,void 0!=a.cookies.user&&void 0!=a.cookies.pass&&(b.cookie("user",e.user,{maxAge:9E6}),b.cookie("pass",e.pass,{maxAge:9E6}),b.cookie("role",e.role,{maxAge:9E6})),b.send("ok",200))}):"true"==a.param("logout")&&l(a,b)});c.get("/signup8979876857869687",f,function(a,b){c.set("view engine","jade");b.render("signup",{title:"Signup",countries:CT,roles:RL})});c.get("/register",f,function(a,
b){c.set("view engine","jade");b.render("registration",{title:"Registration",countries:CT,roles:RL,standards:ST})});c.post("/register",function(a,b){var d=new formidable.IncomingForm;d.uploadDir=__dirname+"/data";d.keepExtensions=!0;c.set("view engine","jade");d.parse(a,function(a,b,c){if(a)console.log("Error in parsing file..."+a);else{(new h.Registration({name:b.name,email:b.email,contactno:b.contactno,country:b.country,board:b.board,standard:b.standard,approvalStatus:0,doc1:c.doc1?c.doc1.path:
"",doc2:c.doc2?c.doc2.path:""})).save();grid.mongo=mongoose.mongo;var d=mongoose.createConnection("mongodb://127.0.0.1:27017/todos");d.once("open",function(){var a=grid(d.db,mongoose.mongo);if(c.doc1)var b=a.createWriteStream({filename:c.doc1.name});c.doc2&&(b=a.createWriteStream({filename:c.doc2.name}));fs.createReadStream(c.doc1.path).pipe(b)})}});d.on("end",function(){b.send("Completed .....");p(a,"New registration request posted")})});c.get("/servicedoc",function(a,b){c.set("view engine","ejs");
b.render("recruiterterms")});c.get("/recruiterterms",function(a,b){c.set("view engine","ejs");b.render("recruiterterms")});c.get("/viewregistration",f,function(a,b){g(a.session.role,"VIEW_REGISTRATION")?(c.set("view engine","jade"),h.Registration.find({approvalStatus:0},function(a,c){b.render("viewregistration",{title:"View & Approve Registration Requests",regDetails:c})})):b.send("Access denied",400)});c.post("/signup8979876857869687",f,function(a,b){c.set("view engine","jade");AM.addNewAccount({name:a.param("name"),
role:a.param("role"),email:a.param("email"),country:a.param("country"),board:a.param("board"),standard:a.param("standard"),user:a.param("user"),pass:a.param("pass"),isActive:!0,isLocked:!1},function(a){a?b.send(a,400):b.send("ok",200)})});c.post("/lost-password",f,function(a,b){c.set("view engine","jade");AM.getAccountByEmail(a.param("email"),function(a){a?(b.send("ok",200),EM.dispatchResetPasswordLink(a,function(a,c){if(a)for(k in b.send("email-server-error",400),a)console.log("error : ",k,a[k])})):
b.send("email-not-found",400)})});c.post("/Contact",f,function(a,b){(new h.Feedback({fbType:a.body.fbType,fbProvider:a.body.fbProvider,fbProviderContact:a.body.fbProviderContact,fbProviderEmail:a.body.fbProviderEmail,fbText:a.body.feedback})).save();b.send("success",200);p(a,"Feedback/Query posted by "+a.body.fbProvider+" - "+a.body.feedback)});c.get("/reset-password",f,function(a,b){var d=a.query.e,e=a.query.p;c.set("view engine","jade");AM.validateResetLink(d,e,function(c){"ok"!=c?b.redirect("/signin"):
(a.session.reset={email:d,passHash:e},b.render("reset",{title:"Reset Password"}))})});c.post("/reset-password",f,function(a,b){var d=a.param("pass"),e=a.session.reset.email;a.session.destroy();c.set("view engine","jade");AM.updatePassword(e,d,function(a,c){c?b.send("ok",200):b.send("unable to update password",400)})});c.get("/activate_user",function(a,b){AM.ActivateUser(a.query.e,a.query.p,function(c,e){e?(b.send("ok",200),p(a,"New user registration - "+a.query.e)):b.send("Unable to activate user - session expired",
400)})});c.get("/print",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):"ToolAdmin"==a.session.role?(c.set("view engine","jade"),AM.getAllRecords(function(a,c){b.render("print",{title:"Account List",accts:c})})):b.send("Access denied",400)});c.post("/delete",f,function(a,b){c.set("view engine","jade");AM.deleteAccount(a.body.id,function(c,e){c?b.send("record not found",400):(b.clearCookie("user"),b.clearCookie("pass"),b.clearCookie("role"),a.session.destroy(function(a){b.send("ok",
200)}))})});c.get("/reset",f,function(a,b){c.set("view engine","jade");AM.delAllRecords(function(){b.redirect("/print")})});c.get("/toolAdmin",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):g(a.session.role,"TOOL_ADMIN")?(c.set("view engine","jade"),b.render("toolAdmin",{title:"Tool Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/toolAdmin",f,function(a,b){"true"==a.param("logout")&&l(a,b)});c.post("/assignCourses",
f,function(a,b){"true"==a.param("logout")&&l(a,b)});c.post("/tools",f,function(a,b){"true"==a.param("logout")&&l(a,b)});c.post("/marketing",f,function(a,b){"true"==a.param("logout")&&l(a,b)});c.post("/rservices",f,function(a,b){var d="";if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if("true"==a.param("logout"))l(a,b);else if(g(a.session.role,"LEARNING_SERVICES")){if(void 0!=a.body.problemStatement)var d=a.body.problemStatement.trim(),e=a.body.method;""!=d&&(new h.VersionedLiterature({userId:a.session.user.user,
method:e,problemStatement:d})).save()}else b.send("Access denied",400)});c.get("/serviceAdmin",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):g(a.session.role,"SERVICE_ADMIN")?(c.set("view engine","jade"),b.render("serviceAdmin",{title:"Service Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.get("/assignmentAdmin",q,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):g(a.session.role,
"SERVICE_ADMIN")?(c.set("view engine","jade"),b.render("assignmentAdmin",{udata:a.session.user})):b.send("Access denied",400)});c.post("/assignmentAdmin",q,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):((new h.Assignment({userId:a.session.user.user,subject:a.body.subject,assignmentId:a.body.assignmentId,fileName:n(a.files.assgfile.path),answerFileName:n(a.files.assgsolfile.path)})).save(),b.end())});c.post("/ViewAssignment",r,function(a,b){null==a.session.user?
(c.set("view engine","jade"),b.redirect("/signin")):((new h.AssignmentSolution({userId:a.session.user.user,assignmentId:a.body.assignmentId,solutionComment:a.body.solutionComment,solutionFile:n(a.files.solutionFile.path)})).save(),b.end())});c.post("/assgSolnReview",r,function(a,b){h.AssignmentSolution.update({_id:ObjectID.createFromHexString(a.body.assignmentId)},{$set:{solutionCorrectionComment:a.body.solutionComment,solutionCorrectionFile:n(a.files.solutionFile.path),date_of_correction:Date.now()}},
{upsert:!1},function(a,b){a&&console.log(a)});b.end()});c.post("/serviceAdmin",f,function(a,b){"true"==a.param("logout")&&l(a,b)});c.get("/cvAdmin",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):g(a.session.role,"RESUME_SERVICE_EXPERT")?(c.set("view engine","jade"),b.render("cvAdmin",{title:"Resume Service Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/cvAdmin",f,function(a,b){"true"==a.param("logout")&&
l(a,b)});c.get("/researchAdmin",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):g(a.session.role,"RESERARCH_ADMIN")?(c.set("view engine","jade"),b.render("researchAdmin",{title:"Research Service Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/researchAdmin",f,function(a,b){"true"==a.param("logout")&&l(a,b)});c.get("/libserviceAdmin",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):
g(a.session.role,"LIBRARY_ADMIN")?(c.set("view engine","jade"),b.render("libserviceAdmin",{title:"Library Service Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/libserviceAdmin",f,function(a,b){"true"==a.param("logout")&&l(a,b)});c.get("/index",t,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):(c.set("view engine","jade"),g(a.session.role,"JOBPOST_INDEX")?b.render("jobpost",{title:"Job Posts: Earn While Learn",
roles:RL,udata:a.session.user,jobtype:["OPEN_TO_ALL","OPEN_FOR_BIDDING","FIXED_PRICE_CONTRACT"],skillcategory:"Accounting;Administration;Art/Design;Engineering Design;Marketing Management;Programming;Project/Product Management;Research;Teaching;Technology;Testing/Verification;Writing".split(";")}):b.send("Access denied",400))});c.get("/demoview",function(a,b){if("ToolAdmin"==a.param("currentrole"))b.redirect("/toolAdmin");else if("ResumeServiceAdmin"==a.param("currentrole"))b.redirect("/cvAdmin");
else if("ResearchAdmin"==a.param("currentrole"))b.redirect("/researchAdmin");else if("Counsellor"==a.param("currentrole")||"Teacher"==a.param("currentrole"))b.redirect("/serviceAdmin");else if("Librarian"==a.param("currentrole"))b.redirect("/libserviceAdmin");else if("Employer"==a.param("currentrole"))b.redirect("/employer");else if("Marketing"==a.param("currentrole"))b.render("marketing",{udata:a.session.user,roles:RL});else if("Recruiter"==a.param("currentrole")||"Premium Recruiter"==a.param("currentrole"))b.redirect("/recruiter");
else if("Registered Student"==a.param("currentrole")||"Star Student"==a.param("currentrole")||"Research Student"==a.param("currentrole"))c.set("view engine","ejs"),b.render("lservices",{title:"Services",udata:a.session.user,quizFiles:[],essayTopics:[]})});c.post("/index",t,function(a,b){var c="",e=a.param("jobId"),f=a.param("jobState");h.Todo.findById(e,function(b,e){b?console.log(b):(999==f?a.files.additionalFile&&(c=a.files.additionalFile.path,e.additionalFile=n(c)):a.files.workFile&&(c=a.files.workFile.path,
e.taskFile=n(c)),e.save(function(b){b?console.log(b):p(a,"New work posted by employer "+a.session.user.user)}))});b.end()});c.get("/download_work",function(a,b){if(g(a.session.role,"DOWNLOAD_WORKFILE")){var c=require("path").resolve(".")+"/upload/workfiles/"+a.param("workFile");b.download(c,a.param("workFile"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download_supportingdoc",function(a,b){if(g(a.session.role,"DOWNLOAD_SUPPORTINGDOC")){var c=__dirname+"/data/"+a.param("fileName");
b.download(c,a.param("fileName"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download_resume",function(a,b){if(g(a.session.role,"DOWNLOAD_RESUME")){var c=require("path").resolve(".")+"/upload/resume/"+a.param("key");b.download(c,a.param("key"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download_report",function(a,b){if(g(a.session.role,"DOWNLOAD_REPORT")){var c=require("path").resolve(".")+"/upload/project/"+a.param("key");b.download(c,
a.param("key"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download_literature",function(a,b){if(g(a.session.role,"DOWNLOAD_LITERATURE")){var c=require("path").resolve(".")+"/upload/literature/"+a.param("key");b.download(c,a.param("key"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/student",function(a,b){c.set("view engine","jade");var d={user:"ExternalUser",email:a.param("user"),contactno:"",country:"",role:"ExternalUser",board:"",standard:"",
isActive:!0,isLocked:!1};a.session.user=d;a.session.role=d.role;d="undefined"==typeof a.param("interest")?"":a.param("interest");h.ExternalUser.update({email:a.param("user")},{$set:{interest:d}},{upsert:!0},function(a,b){a&&console.log(a)});b.render("student",{title:"External Students' Control Panel"})});c.get("/oauth",function(a,b){c.set("view engine","jade");b.render("oauth",{title:"CliqueLearn OAuth"})});c.get("/openresources2",function(a,b){c.set("view engine","jade");b.render("openresources",
{title:"Open Resources",interest:a.param("interest")})});c.get("/openresources",function(a,b){c.set("view engine","jade");if("undefined"===typeof a.param("user"))console.log("not authenticated"),b.redirect("/");else{var d={name:"ExternalUser",email:a.param("user"),contactno:"",country:"",role:"ExternalUser",board:"",standard:"",isActive:!0,isLocked:!1};a.session.user=d;a.session.role=d.role;h.ExternalUser.update({email:a.param("user")},{$set:{interest:a.param("interest")}},{upsert:!0},function(a,
b){a&&console.log(a)});b.render("openresources",{title:"Open Resources",interest:a.param("interest")})}});c.get("/opencm",function(a,b){c.set("view engine","jade");b.render("opencm",{title:"Open Course Materials",interest:a.param("interest")})});c.get("/openassg",function(a,b){c.set("view engine","jade");b.render("openassg",{title:"Open Assignments",interest:a.param("interest")})});c.get("/openquiz",function(a,b){c.set("view engine","jade");b.render("openquiz",{title:"Open Mock Tests",interest:a.param("interest")})});
c.get("/openessay",function(a,b){c.set("view engine","jade");b.render("openessay",{title:"Open Writing Skill Development"})});c.get("/sampleassignment",function(a,b){c.set("view engine","jade");var d=a.param("assgname");"undefined"!==typeof d&&b.render("assignments/"+d)});c.get("/download_paper",function(a,b){if(g(a.session.role,"DOWNLOAD_RESEARCHPAPER")){var c=require("path").resolve(".")+"/upload/research/"+a.param("key");console.log("==>"+c);b.download(c,a.param("key"),function(a){a&&console.log(a)})}else b.send("Access denied",
400)});c.get("/",function(a,b){c.set("view engine","jade");b.render("homepage")});c.get("/competitivedoc",function(a,b){c.set("view engine","jade");b.render("competitivedoc")});c.get("/boarddoc",function(a,b){c.set("view engine","jade");b.render("boarddoc")});c.get("/itdoc",function(a,b){c.set("view engine","jade");b.render("itdoc")});c.get("/cvwriting",function(a,b){c.set("view engine","jade");b.render("cvwriting")});c.get("/counsellingdoc",function(a,b){c.set("view engine","jade");b.render("counsellingdoc")});
c.get("/researchdoc",function(a,b){c.set("view engine","jade");b.render("researchdoc")});c.get("/tools",function(a,b){c.set("view engine","jade");g(a.session.role,"TOOLS")?b.render("tools",{udata:a.session.user,lang:LN}):b.send("Access denied",400)});c.get("/plot",function(a,b){c.set("view engine","ejs");g(a.session.role,"PLOT")?b.render("sketch",{lang:LN}):b.send("Access denied",400)});c.get("/resources",function(a,b){c.set("view engine","jade");g(a.session.role,"RESOURCES")?h.Course.findOne({studyGroup:a.session.user.board+
a.session.user.standard},function(c,e){b.render("resources",{udata:a.session.user,courses:e})}):b.send("Access denied",400)});c.get("/assignCourses",function(a,b){c.set("view engine","jade");g(a.session.role,"ASSIGN_COURSES")?b.render("assignCourses"):b.send("Access denied",400)});c.get("/about",function(a,b){c.set("view engine","jade");b.render("about")});c.get("/contact",function(a,b){c.set("view engine","jade");b.render("contact")});c.get("/freelance",function(a,b){c.set("view engine","jade");
b.render("freelance")});c.get("/freshersjob",function(a,b){c.set("view engine","jade");b.render("freshersjob")});c.get("/locker",f,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):g(a.session.role,"LOCKER")?h.LockerStore.aggregate([{$match:{userId:a.session.user.user}},{$group:{_id:null,sum:{$sum:"$size"}}}],function(a,c){if(a)throw a;c[0]?b.render("locker",{totalSizeLoaded:c[0].sum.toFixed(3)}):b.render("locker",{totalSizeLoaded:0})}):b.send("Access denied",
400)});c.get("/retrieve",f,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):g(a.session.role,"RETRIEVE")?b.render("retrieve"):b.send("Access denied",400)});c.post("/locker",f,function(a,b){var d=a.files.myFile.name;null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):(h.LockerStore.update({$and:[{userId:a.session.user.user},{fileName:d}]},{$set:{key:x(a.files.myFile.path),size:a.param("size")}},{upsert:!0},function(a,b){a&&console.log(a)}),b.end())});
c.post("/premiumjobupload",u,function(a,b){null==a.session.user?console.log("User not logged in"):(null!=a.files&&(new h.PremiumJobStore({userId:a.session.user.user,fileType:a.param("fileType"),fileName:n(a.files.myAdvFile.path)})).save(),b.end())});c.get("/blogController/posts",blogController.posts);c.get("/blogController/post/:id",blogController.post);c.post("/blogController/post",blogController.addPost);c.put("/blogController/post/:id",blogController.editPost);c.delete("/blogController/post/:id",
blogController.deletePost);c.get("/topicController/Topics",topicController.Topics);c.get("/topicController/Topic/:id",topicController.Topic);c.post("/topicController/Topic",topicController.addTopic);c.put("/topicController/Topic/:id",topicController.editTopic);c.delete("/topicController/Topic/:id",topicController.deleteTopic);c.get("/feedbackController/Feedbacks",feedbackController.Feedbacks);c.get("/feedbackController/Feedback/:id",feedbackController.Feedback);c.put("/feedbackController/Feedback/:id",
feedbackController.editFeedback);c.delete("/feedbackController/Feedback/:id",feedbackController.deleteFeedback);c.get("/blogController/viewblogs",blogController.posts);c.get("/accountController/Account",function(a,b){AM.getAllRecords(function(a,c){return b.json(c)})});c.get("/accountController/Account/:id",function(a,b){AM.getRecord(a.params.id,function(a,c){a?b.json({status:!1}):b.json({Account:c,status:!0})})});c.put("/accountController/Account/:id",f,function(a,b){void 0!=a.param("user")&&AM.updateAccount({name:a.param("name"),
email:a.param("email"),contactno:a.param("contactno"),role:a.param("role"),country:a.param("country"),board:a.param("board"),standard:a.param("standard"),user:a.param("user"),pass:a.param("pass")},function(a,c){a?b.json(!1):b.json(!0)})});c.delete("/accountController/Account/:id",f,function(a,b){var c=a.params.id;c&&AM.deleteAccount(c,function(a,c){a?b.json(!1):b.json(!0)})});c.get("/accountController/*",function(a,b){b.send(404)});c.get("/blogController/*",function(a,b){b.send(404)});c.get("/partials/:name",
index._partials);c.get("/partials/*",index.partials);c.get("/blog",index.blog);c.get("/viewblogs",index.viewblog);c.get("/userAdmin",index.userAdmin);c.get("/essayTopicAdmin",index.essayTopicAdmin);c.get("/feedbackAdmin",index.feedbackAdmin);c.get("/chatController/*",function(a,b){b.send(404)});c.get("/quiz",f,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):g(a.session.role,"QUIZ")?"undefined"!=typeof a.param("_id")?h.SessionData.findOne({_id:a.param("_id")},function(c,
e){null!=e&&b.render("quizSession",{title:"Quiz",udata:a.session.user,subject:e.subject,testname:e.testname,sessionId:e.sessionId,elapsedTime:e.elapsedTime,ansJson:e.ansJson,doubtJson:e.doubtJson})}):b.render("quiz",{title:"Quiz",udata:a.session.user,subject:a.param("subject"),testname:a.param("testname")}):b.send("Access denied",400)});c.get("/externalUsers",function(a,b){c.set("view engine","jade");b.render("ViewExternalUsers")});c.post("/lservices",f,function(a,b){var d="";null==a.session.user?
(c.set("view engine","jade"),b.redirect("/signin")):"true"==a.param("logout")?l(a,b):g(a.session.role,"LEARNING_SERVICES")?(void 0!=a.body.academicQuestion&&(d=a.body.academicQuestion.trim()),""!=d&&(new h.AcademicQuestion({userId:a.session.user.user,academicQuestion:d,answer:""})).save()):b.send("Access denied",400)});c.post("/eservices",f,function(a,b){var d="";null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):"true"==a.param("logout")?l(a,b):g(a.session.role,"EARNING_SERVICES")?
(void 0!=a.body.counsel_query&&(d=a.body.counsel_query.trim()),""!=d&&(new h.CareerCounselling({userId:a.session.user.user,counselQuery:d,reply:""})).save()):b.send("Access denied",400)});c.post("/writeEssay",function(a,b){if(a.session.user==a.null)c.set("view engine","jade"),b.redirect("/signin");else{var d="",e="";void 0!=a.body.essaycaption&&void 0!=a.body.essaytxt&&(d=a.body.essaycaption.trim(),e=a.body.essaytxt.replace(/  /g," "),e=e.replace(/\t/g," "),e=e.replace(/\n/g,""));""!=d&&""!=e&&(new h.Essay({userId:a.session.user.user,
essayCaption:d,essayText:e,isEval:!1})).save(function(b,c){b?console.log(b):(h.Essay.update({_id:c._id},{$set:{isEval:!1,expert_score_set:{correctness_of_fact_score:0,grammar_score:0,sentence_constuction_score:0,depth_of_explanation_score:0,clarity_of_thoughts_score:0,choice_of_words_score:0,style_score:0}}},{upsert:!1},function(a,b){a&&console.log(a)}),h.SessionData.remove({sessionId:a.body.sessionId},function(a){a&&console.log(a)}))})}});c.post("/autosave",function(a,b){h.SessionData.update({$and:[{userId:a.session.user.user},
{sessionId:a.body.sessionId}]},{$set:{elapsedTime:a.body.elapsedTime,essaycaption:a.body.essaycaption,essaytxt:a.body.essaytxt}},{upsert:!0},function(a,b){a&&console.log(a)})});c.post("/autosave2",function(a,b){null!=a.session.user&&h.SessionData.findOne({$and:[{userId:a.session.user.user},{sessionId:a.body.sessionId}]},function(b,c){b||(c?c.elapsedTime>a.body.elapsedTime&&(c.elapsedTime=a.body.elapsedTime,c.subject=a.body.subject,c.testname=a.body.testname,c.ansJson=a.body.ansJson,c.doubtJson=a.body.doubtJson,
c.save(function(a){a&&console.log(a)})):h.SessionData.update({$and:[{userId:a.session.user.user},{sessionId:a.body.sessionId}]},{$set:{elapsedTime:a.body.elapsedTime,subject:a.body.subject,testname:a.body.testname,ansJson:a.body.ansJson,doubtJson:a.body.doubtJson}},{upsert:!0},function(a,b){a&&console.log(a)}))})});c.get("/scoreessays",function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):g(a.session.role,"SCORE_ESSAYS")?h.Essay.find({isEval:!1},function(a,c){b.render("scoreessays",
{title:"Score Essays",essayDetails:c})}):b.send("Access denied",400)});c.get("/essayscores",function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):g(a.session.role,"VIEW_ESSAY_SCORES")?h.Essay.find({userId:a.session.user.user},function(a,c){b.render("viewessayscores",{title:"View Essay Scores",essayDetails:c})}):b.send("Access denied",400)});c.get("/pdfkit",function(a,b){c.set("view engine","ejs");null==a.session.user?b.redirect("/signin"):g(a.session.role,"PDFKIT")?
b.render("pdfkit"):b.send("Access denied",400)});c.get("/codeedit",function(a,b){c.set("view engine","ejs");null==a.session.user?b.redirect("/signin"):g(a.session.role,"CODEEDIT")?b.render("codeedit",{lang:a.param("lang")}):b.send("Access denied",400)});c.post("/retrieve",f,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var d=a.body.myFile;if("undefined"!=typeof d){var e="";-1!=d.lastIndexOf(".")&&(e=d.substring(d.lastIndexOf("."),d.len));h.LockerStore.findOne({$and:[{userId:a.session.user.user},
{fileName:d}]},function(a,c){if(!a)if(c){var d=c.key+e,d=require("path").resolve(".")+"/upload/locker/"+d;b.download(d,function(a){a&&console.log(a)})}else console.log("No record found!")})}}});c.get("/associateRoles",function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):g(a.session.role,"ASSOCIATE_ROLE")?b.render("associateRoles",{title:"Associate Role with Functionality",roleMap:roleMap}):b.send("Access denied",400)});c.post("/associateRoles",function(a,b){var c=a.param("rolename"),
e=a.param("unit_func_list");RL.push({"short":"**",name:c,unit_function:e})});c.get("/createTest",function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):g(a.session.role,"CREATE_TEST")?b.render("createTest",{title:"Configure A Mock Test",udata:a.session.user}):b.send("Access denied",400)});c.post("/postImage",v,function(a,b){b.writeHead(200,a.files.qImageFile.path);b.end()});c.get("/selectedImage",function(a,b){var c=a.param("imageFile");b.sendfile(c)});c.post("/createTest",
f,function(a,b){var c=a.param("qp"),e=a.param("testname");fs.writeFile(__dirname+"/../../lib/"+e+".json",c,function(a){if(a)return console.log(a);console.log("The file"+e+".json was saved!")})});c.post("/viewregistration",function(a,b){if(g(a.session.role,"VIEW_REGISTRATION")){var c=a.param("id"),e=a.param("approvalStatus");h.Registration.update({_id:c},{$set:{approvalStatus:e}},{upsert:!0},function(a,b){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download",f,function(a,b){if(null==
a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if(g(a.session.role,"DOWNLOAD_LIBRARY_BOOKS")){require("path");var d=__dirname+"/Resources/Books/"+a.param("fileName");b.download(d,function(a){a&&console.log("Error downloading file from library")})}else b.send("Access denied",400)});c.get("/download_assg",q,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if(g(a.session.role,"DOWNLOAD_ASSIGNMENT")){require("path");var d=__dirname+"/Resources/Assignments/"+
a.param("fileName");b.download(d,function(a){a&&console.log("Error downloading file from library: "+a)})}else b.send("Access denied",400)});c.get("/download_assgsol",r,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if(g(a.session.role,"DOWNLOAD_ASSIGNMENT_SOLUTION")){var d=require("path"),e=__dirname+"/../../upload/assignmentsoln/"+a.param("fileName");b.download(d.resolve(e),function(a){a&&console.log("Error downloading file from assignment store: "+a)})}else b.send("Access denied",
400)});c.get("/robots.txt",f,function(a,b){fs.readFile(__dirname+"/../../robots.txt",function(a,c){b.end(c)})});c.get("*",function(a,b){c.set("view engine","jade");b.render("404",{title:"Page Not Found"})});var l=function(a,b){b.clearCookie("user");b.clearCookie("pass");b.clearCookie("role");a.session.destroy(function(a){b.send("ok",200)})},x=function(a){a=a.replace(/\\/g,"/").replace(/.*\//,"");-1!=a.lastIndexOf(".")&&(a=a.substring(0,a.lastIndexOf(".")));return a},n=function(a){return a.replace(/\\/g,
"/").replace(/.*\//,"")},g=function(a,b){var c=-1;console.log("RESOURCE:"+b);var e=Object.keys(RL),f;for(f in e)RL[f].name==a&&(c=f);if(0<=c)for(e=0;e<RL[c].unit_function.length;e++)if(b==RL[c].unit_function[e])return!0;return!1},w=function(a){var b=os.networkInterfaces();Object.keys(b).forEach(function(c){b[c].forEach(function(b){if("IPv4"!==b.family||!1!==b.internal)return"";null!=a.session.user&&(console.log(c,b.address),(new h.LoginRecord({userId:a.session.user.user,interfaceName:c+":0",ipAddress:b.address})).save())})})},
p=function(a,b){if(null!=a.session.user){var c={from:"CliqueLearn Admin <admin@cliquelearn.org>",to:[a.session.user.email,"admin@cliquelearn.org"],subject:"Notification from CliqueLearn",text:b};mailgun.messages().send(c,function(a,b){console.log(b)})}else c={from:"CliqueLearn Admin <admin@cliquelearn.org>",to:"admin@cliquelearn.org",subject:"Notification from CliqueLearn",text:b},mailgun.messages().send(c,function(a,b){console.log(b)})}};
