var http=require("http"),express=require("express"),formidable=require("formidable"),grid=require("gridfs-stream"),mongoose=require("mongoose"),fs=require("fs"),os=require("os"),path=require("path"),ObjectID=require("mongodb").ObjectID,api_key="key-65537839e609bd6456874e646f05177f",domain="sandbox517084dd6ee74222adf91a15cf140d92.mailgun.org",mailgun=require("mailgun-js")({apiKey:api_key,domain:domain}),CT=require("./modules/country-list"),CITY=require("./modules/city-list"),RL=require("./modules/role-list"),
ST=require("./modules/standard-list"),LN=require("./modules/lang-list"),AM=require("./modules/account-manager"),EM=require("./modules/email-dispatcher"),roleMap=require("./modules/roleMap"),blogController=require("../public/js/controllers/blogController.js"),topicController=require("../public/js/controllers/topicController.js"),feedbackController=require("../public/js/controllers/feedbackController.js"),index=require("../public/js/controllers/index.js");
module.exports=function(c,g){var h=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/locker",limit:"2mb"}),y=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/advjob",limit:"5mb"}),z=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/qpaper",limit:"2mb"}),u=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"/Resources/Assignments/",limit:"10mb"}),v=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/assignmentsoln",
limit:"2mb"}),x=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/workfiles",limit:"10mb"}),w=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/research",limit:"5mb"}),r=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/project",limit:"5mb"}),A=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/literature",limit:"50mb"}),t=express.bodyParser({keepExtensions:!0,uploadDir:__dirname+"../../../upload/resume",
limit:"2mb"});c.get("/signin",h,function(a,b){void 0==a.cookies.user||void 0==a.cookies.pass?(c.set("view engine","jade"),b.render("login",{title:"Hello - Please Login To Your Account"})):AM.autoLogin(a.cookies.user,a.cookies.pass,function(d){null!=d?(a.session.user=d,a.session.role=d.role,c.set("view engine","ejs"),"ToolAdmin"==a.session.role?b.redirect("/toolAdmin"):"ResumeServiceAdmin"==a.session.role?b.redirect("/cvAdmin"):"ResearchAdmin"==a.session.role?b.redirect("/researchAdmin"):"Teacher"==
a.session.role||"Counsellor"==a.session.role?b.redirect("/serviceAdmin"):"Librarian"==a.session.role?b.redirect("/libserviceAdmin"):"Employer"==a.session.role?b.redirect("/employer"):"Marketing"==a.session.role?b.redirect("/marketing"):"Registered Student"==a.session.role||"Star Student"==a.session.role||"Research Student"==a.session.role?b.redirect("/lservices"):"Recruiter"==a.session.role||"Premium Recruiter"==a.session.role?b.redirect("/recruiter"):b.redirect("/signin")):(c.set("view engine","jade"),
b.render("login",{title:"Hello - Please Login To Your Account"}))})});c.post("/signin",h,function(a,b){c.set("view engine","jade");AM.manualLogin(a.param("user"),a.param("pass"),function(c,e){e?(a.session.user=e,a.session.role=e.role,"true"==a.param("remember-me")&&(b.cookie("user",e.user,{maxAge:9E6}),b.cookie("pass",e.pass,{maxAge:9E6}),b.cookie("role",e.role,{maxAge:9E6})),b.send(e,200)):b.send(c,400)})});c.get("/lservices",h,function(a,b){var d=[],e=[];B(a);c.set("view engine","jade");if(null==
a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if("ToolAdmin"==a.session.role)b.redirect("/toolAdmin");else if("ResumeServiceAdmin"==a.session.role)b.redirect("/cvAdmin");else if("ResearchAdmin"==a.session.role)b.redirect("/researchAdmin");else if("Counsellor"==a.session.role||"Teacher"==a.session.role)b.redirect("/serviceAdmin");else if("Librarian"==a.session.role)b.redirect("/libserviceAdmin");else if("Employer"==a.session.role)b.redirect("/employer");else if("Marketing"==
a.session.role)b.redirect("/marketing");else if("Recruiter"==a.session.role||"Premium Recruiter"==a.session.role)b.redirect("/recruiter");else if("Registered Student"==a.session.role||"Star Student"==a.session.role||"Research Student"==a.session.role)c.set("view engine","ejs"),g.Assoc.find({studygroup:a.session.user.board+a.session.user.standard},function(c,p){if(!c){if(0<p.length){for(var f=p[0].assoc_file,h=p[0].assoc_topic,g=0;g<f.length;g++)d.push(f[g].qFile);for(g=0;g<h.length;g++)e.push(h[g].assoc_topic)}b.render("lservices",
{title:"Services",udata:a.session.user,quizFiles:d,essayTopics:e})}})});c.get("/eservices",h,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"EARNING_SERVICES")?(c.set("view engine","ejs"),b.render("eservices",{title:"Services",udata:a.session.user})):b.send("Access denied",400)});c.get("/rservices",h,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"RESEARCH_HOME")?(c.set("view engine",
"ejs"),b.render("rservices",{title:"Research",udata:a.session.user})):b.send("Access denied",400)});c.get("/guidedprojects",function(a,b){b.render("guidedprojects")});c.get("/openEssay",function(a,b){g.EssayTopic.count({},function(a,c){if(!a)var n=1+Math.floor(Math.random()*c);g.EssayTopic.find({topicId:n},function(a,c){a?console.log(a):(topic=0!=c.length?c[0].essayTopic:"Error: Could not generate a topic",b.render("openessay",{topic:topic}))})})});c.get("/Resources/Course",function(a,b){c.set("view engine",
"ejs");var d=a.param("coursename");"undefined"===typeof d?b.send("Course not found",400):b.render("courses/"+d)});c.get("/writeEssay",function(a,b){c.set("view engine","jade");if(null==a.session.user)b.redirect("/signin");else if(f(a.session.role,"WRITE_ESSAY"))if("undefined"!=typeof a.param("_id"))g.SessionData.findOne({_id:a.param("_id")},function(a,c){b.render("writeEssaySession",{sessionId:c.sessionId,elapsedTime:c.elapsedTime,topic:c.essaycaption,essaytxt:c.essaytxt})});else{var d=a.param("method"),
e="";1==d?g.EssayTopic.count({},function(a,c){if(!a)var f=1+Math.floor(Math.random()*c);g.EssayTopic.find({topicId:f},function(a,c){a?console.log(a):(e=0!=c.length?c[0].essayTopic:"Error: Could not generate a topic",b.render("writeEssay",{topicSelectionMethod:d,topic:e}))})}):b.render("writeEssay",{topicSelectionMethod:a.param("method")})}else b.send("Access denied",400)});c.get("/startThread",h,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,
"DISCUSSION_THREAD")?b.render("thread",{udata:a.session.user}):b.send("Access denied",400)});c.get("/viewThreads",h,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"DISCUSSION_THREAD_EXPERT")?b.render("viewThreads",{udata:a.session.user}):b.send("Access denied",400)});c.get("/viewThread",h,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"VIEW_DISCUSSION_THREAD")?b.render("viewThreads"):b.send("Access denied",
400)});c.get("/postPaper",w,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"POST_PAPER")?b.render("postpaper",{purpose:a.param("purpose")}):b.send("Access denied",400)});c.get("/postReport",r,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"POST_REPORT")?b.render("postReport"):b.send("Access denied",400)});c.get("/postResume",t,function(a,b){c.set("view engine","jade");null==a.session.user?
b.redirect("/signin"):f(a.session.role,"POST_RESUME")?b.render("postResume"):b.send("Access denied",400)});c.post("/postLiteratureVersion",A,function(a,b){var d=a.param("_id"),e=a.param("comment"),n=parseInt(a.param("lastVersionNum"))+1;if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var f={key:l(a.files.versionFile.path),author:a.session.user.user,versionNum:n,versionComment:e};g.VersionedLiterature.findOne({_id:d},function(a,b){a||b&&g.VersionedLiterature.update({_id:d},
{$addToSet:{literatureVersion:f}},{upsert:!1},function(a,b){a&&console.log(a)})})}b.end()});c.get("/courseInfoGMAT1",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/courseInfoGMAT1.json","utf8"));b.send(c)});c.get("/courseInfoGMAT2",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/courseInfoGMAT2.json","utf8"));b.send(c)});c.get("/courseInfoGMAT3",function(a,
b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/courseInfoGMAT3.json","utf8"));b.send(c)});c.get("/skillInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/skillInfo.json","utf8"));b.send(c)});c.get("/companyInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/companyInfo.json","utf8"));
b.send(c)});c.get("/industryInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/industryInfo.json","utf8"));b.send(c)});c.get("/locationInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/locationInfo.json","utf8"));b.send(c)});c.get("/roleInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+
"/../public/vendor/roleInfo.json","utf8"));b.send(c)});c.get("/salaryInfo",function(a,b){b.setHeader("Content-Type","application/json");var c=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/salaryInfo.json","utf8"));b.send(c)});c.post("/postPaper",w,function(a,b){var d=a.param("paperTitle"),e=a.param("purpose");if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var n={key:l(a.files.researchFile.path),author:a.session.user.user,versionNum:1};(new g.VersionedPaper({userId:a.session.user.user,
paperTitle:d,purpose:e,paperFile:a.files.researchFile.name,paperVersion:[n]})).save(function(a,b){a?console.log(a):console.log(b._id)});b.end();q(a,"New paper posted for review - Title:"+d)}});c.post("/postPaperVersion",w,function(a,b){var d=a.param("_id"),e=a.param("comment"),n=parseInt(a.param("lastVersionNum"))+1;if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var f={key:l(a.files.versionFile.path),author:a.session.user.user,versionNum:n,versionComment:e};g.VersionedPaper.findOne({_id:d},
function(a,b){a||b&&g.VersionedPaper.update({_id:d},{$addToSet:{paperVersion:f}},{upsert:!1},function(a,b){a&&console.log(a)})})}b.end()});c.post("/postReportVersion",r,function(a,b){var d=a.param("_id"),e=a.param("comment"),n=parseInt(a.param("lastVersionNum"))+1;if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var f={key:l(a.files.versionFile.path),author:a.session.user.user,versionNum:n,versionComment:e};g.VersionedReport.findOne({_id:d},function(a,b){a||b&&g.VersionedReport.update({_id:d},
{$addToSet:{reportVersion:f}},{upsert:!1},function(a,b){a&&console.log(a)})})}b.end()});c.post("/postReport",r,function(a,b){var d=a.param("reportTitle");if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var e={key:l(a.files.projectFile.path),author:a.session.user.user,versionNum:1};(new g.VersionedReport({userId:a.session.user.user,reportTitle:d,reportFile:a.files.projectFile.name,reportVersion:[e]})).save(function(a,b){a?console.log(a):console.log(b._id)});b.end();q(a,
"New report posted for review - Title:"+d)}});c.post("/postResume",t,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var d={key:l(a.files.resumeFile.path),author:a.session.user.user,versionNum:1};(new g.VersionedResume({userId:a.session.user.user,resumeFile:a.files.resumeFile.name,resumeVersion:[d]})).save(function(a,b){a?console.log(a):console.log(b._id)});b.end();q(a,"New resume posted by user "+a.session.user.user)}});c.post("/postResumeVersion",t,function(a,
b){var d=a.param("_id"),e=a.param("comment"),n=parseInt(a.param("lastVersionNum"))+1;if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var f={key:l(a.files.versionFile.path),author:a.session.user.user,versionNum:n,versionComment:e};g.VersionedResume.findOne({_id:d},function(a,b){a||b&&g.VersionedResume.update({_id:d},{$addToSet:{resumeVersion:f}},{upsert:!1},function(a,b){a&&console.log(a)})})}b.end()});c.get("/resumeVM",t,function(a,b){null==a.session.user?(c.set("view engine",
"jade"),b.redirect("/signin")):f(a.session.role,"RESUME_VM")?g.VersionedResume.find({userId:a.session.user.user},function(a,c){b.render("resumeVM",{vmDetails:c})}):b.send("Access denied",400)});c.get("/cvManage",t,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"CV_VM")?g.VersionedResume.find({},function(a,c){b.render("resumeVM",{vmDetails:c})}):b.send("Access denied",400)});c.get("/literatureVM",function(a,b){null==a.session.user?(c.set("view engine",
"jade"),b.redirect("/signin")):f(a.session.role,"SEARCH_VM")?g.VersionedLiterature.find({},function(a,c){b.render("literatureVM",{literatureDetails:c})}):b.send("Access denied",400)});c.get("/paperVM",h,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if(f(a.session.role,"PAPER_VM")){var d=a.param("purpose");g.VersionedPaper.find({$and:[{userId:a.session.user.user},{purpose:d}]},function(a,c){b.render("paperVM",{paperDetails:c})})}else b.send("Access denied",
400)});c.get("/reportVM",r,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"REPORT_VM")?g.VersionedReport.find({userId:a.session.user.user},function(a,c){b.render("reportVM",{reportDetails:c})}):b.send("Access denied",400)});c.get("/revResearch",h,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if(f(a.session.role,"REV_RESEARCH_EXPERT")){var d=a.param("purpose");g.VersionedPaper.find({purpose:d},function(a,
c){b.render("paperVM",{paperDetails:c})})}else b.send("Access denied",400)});c.get("/revReports",r,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"REV_PROJECTREPORT_EXPERT")?g.VersionedReport.find({},function(a,c){b.render("reportVM",{reportDetails:c})}):b.send("Access denied",400)});c.get("/accountsettings",h,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"VIEW_SELF_ACCOUNTSETTING")?(c.set("view engine",
"jade"),b.render("home",{title:"Control Panel",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/accountsettings",h,function(a,b){c.set("view engine","jade");void 0!=a.param("user")?AM.updateAccount({name:a.param("name"),email:a.param("email"),contactno:a.param("contactno"),role:a.param("role"),country:a.param("country"),board:a.param("board"),standard:a.paramm("standard"),user:a.param("user"),pass:a.param("pass"),isActive:!0,isLocked:!1},function(c,e){c?b.send("error-updating-account",
400):(a.session.user=e,void 0!=a.cookies.user&&void 0!=a.cookies.pass&&(b.cookie("user",e.user,{maxAge:9E6}),b.cookie("pass",e.pass,{maxAge:9E6}),b.cookie("role",e.role,{maxAge:9E6})),b.send("ok",200))}):"true"==a.param("logout")&&m(a,b)});c.get("/signup8979876857869687",h,function(a,b){c.set("view engine","jade");f(a.session.role,"VIEW_SELF_ACCOUNTSETTING")?b.render("signup",{title:"Signup",countries:CT,roles:RL}):b.send("Access denied",400)});c.get("/signupEmp",h,function(a,b){c.set("view engine",
"jade");b.render("signupEmp",{title:"Signup",countries:CT,roles:RL})});c.get("/signupRec",h,function(a,b){c.set("view engine","jade");b.render("signupRec",{title:"Signup",countries:CT,roles:RL})});c.get("/register",h,function(a,b){c.set("view engine","jade");b.render("registration",{title:"Registration",countries:CT,roles:RL,standards:ST})});c.post("/register",function(a,b){var d=new formidable.IncomingForm;d.uploadDir=__dirname+"/data";d.keepExtensions=!0;c.set("view engine","jade");d.parse(a,function(a,
b,c){if(a)console.log("Error in parsing file..."+a);else{(new g.Registration({name:b.name,email:b.email,contactno:b.contactno,country:b.country,board:b.board,standard:b.standard,approvalStatus:0,doc1:c.doc1?c.doc1.path:"",doc2:c.doc2?c.doc2.path:""})).save();grid.mongo=mongoose.mongo;var d=mongoose.createConnection("mongodb://127.0.0.1:27017/todos");d.once("open",function(){var a=grid(d.db,mongoose.mongo);if(c.doc1)var b=a.createWriteStream({filename:c.doc1.name});c.doc2&&(b=a.createWriteStream({filename:c.doc2.name}));
fs.createReadStream(c.doc1.path).pipe(b)})}});d.on("end",function(){b.send("Completed .....");q(a,"New registration request posted")})});c.get("/billboard",function(a,b){c.set("view engine","jade");b.render("billboard")});c.get("/servicedoc",function(a,b){c.set("view engine","ejs");b.render("recruiterterms")});c.get("/recruiterterms",function(a,b){c.set("view engine","ejs");b.render("recruiterterms")});c.get("/freelanceterms",function(a,b){c.set("view engine","ejs");b.render("recruiterterms")});c.get("/viewregistration",
h,function(a,b){f(a.session.role,"VIEW_REGISTRATION")?(c.set("view engine","jade"),g.Registration.find({approvalStatus:0},function(a,c){b.render("viewregistration",{title:"View & Approve Registration Requests",regDetails:c})})):b.send("Access denied",400)});c.get("/results",h,function(a,b){f(a.session.role,"RESULTS")?(c.set("view engine","jade"),(new g.ProgressReport({userId:a.session.user.user,subject:a.param("subject"),testname:a.param("testname"),time:new Date,score:a.param("score"),maxscore:a.param("maxscore")})).save(),
b.render("results",{title:"Results",udata:a.session.user,time:new Date,subject:a.param("subject"),testname:a.param("testname"),score:a.param("score"),maxscore:a.param("maxscore"),token:a.param("token")})):b.send("Access denied",400)});c.get("/sampleresults",h,function(a,b){c.set("view engine","jade");b.render("results",{title:"Results",udata:a.session.user,time:new Date,subject:a.param("subject"),testname:a.param("testname"),score:a.param("score"),maxscore:a.param("maxscore")})});c.post("/signup8979876857869687",
h,function(a,b){c.set("view engine","jade");AM.addNewAccount({name:a.param("name"),role:a.param("role"),email:a.param("email"),country:a.param("country"),board:a.param("board"),standard:a.param("standard"),user:a.param("user"),pass:a.param("pass"),isActive:!0,isLocked:!1},function(a){a?b.send(a,400):b.send("ok",200)})});c.post("/signupemp",h,function(a,b){c.set("view engine","jade");AM.addNewAccount({name:a.param("name"),role:a.param("role"),contactno:a.param("contactno"),email:a.param("email"),country:a.param("country"),
user:a.param("user"),pass:a.param("pass"),isActive:!1,isLocked:!1},function(a,c){a?b.send(a,400):(b.send("ok",200),EM.dispatchAccountActivationLink(c,function(a,c){if(a)for(k in b.send("email-server-error",400),a)console.log("error : ",k,a[k])}))})});c.post("/signuprec",h,function(a,b){c.set("view engine","jade");AM.addNewAccount({name:a.param("name"),role:a.param("role"),contactno:a.param("contactno"),email:a.param("email"),country:a.param("country"),user:a.param("user"),pass:a.param("pass"),isActive:!1,
isLocked:!1},function(a,c){a?b.send(a,400):(b.send("ok",200),EM.dispatchAccountActivationLink(c,function(a,c){if(a)for(k in b.send("email-server-error",400),a)console.log("error : ",k,a[k])}))})});c.post("/lost-password",h,function(a,b){c.set("view engine","jade");AM.getAccountByEmail(a.param("email"),function(a){a?(b.send("ok",200),EM.dispatchResetPasswordLink(a,function(a,c){if(a)for(k in b.send("email-server-error",400),a)console.log("error : ",k,a[k])})):b.send("email-not-found",400)})});c.post("/Contact",
h,function(a,b){(new g.Feedback({fbType:a.body.fbType,fbProvider:a.body.fbProvider,fbProviderContact:a.body.fbProviderContact,fbProviderEmail:a.body.fbProviderEmail,fbText:a.body.feedback})).save();b.send("success",200);q(a,"Feedback/Query posted by "+a.body.fbProvider+" - "+a.body.feedback)});c.get("/reset-password",h,function(a,b){var d=a.query.e,e=a.query.p;c.set("view engine","jade");AM.validateResetLink(d,e,function(c){"ok"!=c?b.redirect("/signin"):(a.session.reset={email:d,passHash:e},b.render("reset",
{title:"Reset Password"}))})});c.post("/reset-password",h,function(a,b){var d=a.param("pass"),e=a.session.reset.email;a.session.destroy();c.set("view engine","jade");AM.updatePassword(e,d,function(a,c){c?b.send("ok",200):b.send("unable to update password",400)})});c.get("/activate_user",function(a,b){AM.ActivateUser(a.query.e,a.query.p,function(c,e){e?(b.send("ok",200),q(a,"New user registration - "+a.query.e)):b.send("Unable to activate user - session expired",400)})});c.get("/print",h,function(a,
b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):"ToolAdmin"==a.session.role?(c.set("view engine","jade"),AM.getAllRecords(function(a,c){b.render("print",{title:"Account List",accts:c})})):b.send("Access denied",400)});c.post("/delete",h,function(a,b){c.set("view engine","jade");AM.deleteAccount(a.body.id,function(c,e){c?b.send("record not found",400):(b.clearCookie("user"),b.clearCookie("pass"),b.clearCookie("role"),a.session.destroy(function(a){b.send("ok",200)}))})});
c.get("/reset",h,function(a,b){c.set("view engine","jade");AM.delAllRecords(function(){b.redirect("/print")})});c.get("/toolAdmin",h,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"TOOL_ADMIN")?(c.set("view engine","jade"),b.render("toolAdmin",{title:"Tool Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/toolAdmin",h,function(a,b){"true"==a.param("logout")&&m(a,b)});c.post("/assignCourses",
h,function(a,b){"true"==a.param("logout")&&m(a,b)});c.post("/tools",h,function(a,b){"true"==a.param("logout")&&m(a,b)});c.post("/marketing",h,function(a,b){"true"==a.param("logout")&&m(a,b)});c.post("/rservices",h,function(a,b){var d="";if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if("true"==a.param("logout"))m(a,b);else if(f(a.session.role,"LEARNING_SERVICES")){if(void 0!=a.body.problemStatement)var d=a.body.problemStatement.trim(),e=a.body.method;""!=d&&(new g.VersionedLiterature({userId:a.session.user.user,
method:e,problemStatement:d})).save()}else b.send("Access denied",400)});c.get("/serviceAdmin",h,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"SERVICE_ADMIN")?(c.set("view engine","jade"),b.render("serviceAdmin",{title:"Service Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.get("/assignmentAdmin",u,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,
"SERVICE_ADMIN")?(c.set("view engine","jade"),b.render("assignmentAdmin",{udata:a.session.user})):b.send("Access denied",400)});c.post("/assignmentAdmin",u,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):((new g.Assignment({userId:a.session.user.user,subject:a.body.subject,assignmentId:a.body.assignmentId,fileName:l(a.files.assgfile.path),answerFileName:l(a.files.assgsolfile.path)})).save(),b.end())});c.post("/ViewAssignment",v,function(a,b){null==a.session.user?
(c.set("view engine","jade"),b.redirect("/signin")):((new g.AssignmentSolution({userId:a.session.user.user,assignmentId:a.body.assignmentId,solutionComment:a.body.solutionComment,solutionFile:l(a.files.solutionFile.path)})).save(),b.end())});c.post("/assgSolnReview",v,function(a,b){g.AssignmentSolution.update({_id:ObjectID.createFromHexString(a.body.assignmentId)},{$set:{solutionCorrectionComment:a.body.solutionComment,solutionCorrectionFile:l(a.files.solutionFile.path),date_of_correction:Date.now()}},
{upsert:!1},function(a,b){a&&console.log(a)});b.end()});c.post("/serviceAdmin",h,function(a,b){"true"==a.param("logout")&&m(a,b)});c.get("/cvAdmin",h,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"RESUME_SERVICE_EXPERT")?(c.set("view engine","jade"),b.render("cvAdmin",{title:"Resume Service Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/cvAdmin",h,function(a,b){"true"==a.param("logout")&&
m(a,b)});c.get("/researchAdmin",h,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"RESERARCH_ADMIN")?(c.set("view engine","jade"),b.render("researchAdmin",{title:"Research Service Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/researchAdmin",h,function(a,b){"true"==a.param("logout")&&m(a,b)});c.get("/libserviceAdmin",h,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):
f(a.session.role,"LIBRARY_ADMIN")?(c.set("view engine","jade"),b.render("libserviceAdmin",{title:"Library Service Administration",countries:CT,roles:RL,udata:a.session.user})):b.send("Access denied",400)});c.post("/libserviceAdmin",h,function(a,b){"true"==a.param("logout")&&m(a,b)});c.get("/index",x,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):(c.set("view engine","jade"),f(a.session.role,"JOBPOST_INDEX")?b.render("jobpost",{title:"Job Posts: Earn While Learn",
roles:RL,udata:a.session.user,jobtype:["OPEN_TO_ALL","OPEN_FOR_BIDDING","FIXED_PRICE_CONTRACT"],skillcategory:"Accounting;Administration;Art/Design;Engineering Design;Marketing Management;Programming;Project/Product Management;Research;Teaching;Technology;Testing/Verification;Writing".split(";")}):b.send("Access denied",400))});c.get("/advertisedjobs",function(a,b){c.set("view engine","jade");for(var d=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/roleInfo.json","utf8")),e=[],f=0;f<d.children.length;f++)for(var g=
0;g<d.children[f].children.length;g++)e.push(d.children[f].children[g].label);b.render("advertisedjob",{udata:a.session.user,skillcategory:"Accounting;Administration;Art/Design;Engineering Design;Marketing Management;Programming;Project/Product Management;Research;Teaching;Technology;Testing/Verification;Writing".split(";"),roleList:e,city:CITY})});c.get("/recruiter",function(a,b){c.set("view engine","jade");f(a.session.role,"RECRUITER_HOME")?b.render("recruiter"):b.send("Access denied",400)});c.get("/employer",
function(a,b){c.set("view engine","jade");f(a.session.role,"JOBPOST_INDEX")?b.render("employer"):b.send("Access denied",400)});c.get("/marketing",function(a,b){c.set("view engine","jade");b.render("marketing",{udata:a.session.user,roles:RL})});c.get("/demoview",function(a,b){if("ToolAdmin"==a.param("currentrole"))b.redirect("/toolAdmin");else if("ResumeServiceAdmin"==a.param("currentrole"))b.redirect("/cvAdmin");else if("ResearchAdmin"==a.param("currentrole"))b.redirect("/researchAdmin");else if("Counsellor"==
a.param("currentrole")||"Teacher"==a.param("currentrole"))b.redirect("/serviceAdmin");else if("Librarian"==a.param("currentrole"))b.redirect("/libserviceAdmin");else if("Employer"==a.param("currentrole"))b.redirect("/employer");else if("Marketing"==a.param("currentrole"))b.render("marketing",{udata:a.session.user,roles:RL});else if("Recruiter"==a.param("currentrole")||"Premium Recruiter"==a.param("currentrole"))b.redirect("/recruiter");else if("Registered Student"==a.param("currentrole")||"Star Student"==
a.param("currentrole")||"Research Student"==a.param("currentrole"))c.set("view engine","ejs"),b.render("lservices",{title:"Services",udata:a.session.user,quizFiles:[],essayTopics:[]})});c.get("/upload/advjob/:file",function(a,b){var c=a.params.file,e=fs.readFileSync(__dirname+"/../../upload/advjob/"+c);-1!=c.lastIndexOf(".")&&(ext=c.substring(c.lastIndexOf(".")+1,c.length));"jpg"==ext?(b.writeHead(200,{"Content-Type":"image/jpg"}),b.end(e,"binary")):"jpeg"==ext?(b.writeHead(200,{"Content-Type":"image/jpeg"}),
b.end(e,"binary")):"png"==ext?(b.writeHead(200,{"Content-Type":"image/png"}),b.end(e,"binary")):"gif"==ext?(b.writeHead(200,{"Content-Type":"image/gif"}),b.end(e,"binary")):"bmp"==ext?(b.writeHead(200,{"Content-Type":"image/bmp"}),b.end(e,"binary")):"svg"==ext&&(b.writeHead(200,{"Content-Type":"image/svg"}),b.end(e,"binary"))});c.get("/premiumassoc",function(a,b){c.set("view engine","jade");if(f(a.session.role,"PREMIUM_JOBPOST")){for(var d=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/roleInfo.json",
"utf8")),e=[],h=0;h<d.children.length;h++)for(var p=0;p<d.children[h].children.length;p++)e.push(d.children[h].children[p].label);var C=fs.readdirSync(__dirname+"/../../lib","utf8"),l=[];g.AdvertisedJob.find({$and:[{recruiterId:a.session.user.user},{isPremium:!0}]},function(c,d){for(var f=0;f<d.length;f++)console.log(d[f]._id),l.push(d[f]._id.toString());b.render("premiumassoc",{udata:a.session.user,skillcategory:"Accounting;Administration;Art/Design;Engineering Design;Marketing Management;Programming;Project/Product Management;Research;Teaching;Technology;Testing/Verification;Writing".split(";"),
roleList:e,city:CITY,premiumjobs:l,screeningTestList:C})})}else b.send("Access denied",400)});c.get("/premiumjobs",function(a,b){c.set("view engine","jade");for(var d=JSON.parse(fs.readFileSync(__dirname+"/../public/vendor/roleInfo.json","utf8")),e=[],f=0;f<d.children.length;f++)for(var g=0;g<d.children[f].children.length;g++)e.push(d.children[f].children[g].label);b.render("premiumjobs",{udata:a.session.user,skillcategory:"Accounting;Administration;Art/Design;Engineering Design;Marketing Management;Programming;Project/Product Management;Research;Teaching;Technology;Testing/Verification;Writing".split(";"),
roleList:e,city:CITY})});c.get("/premiumjobupload",function(a,b){c.set("view engine","jade");f(a.session.role,"PREMIUM_JOBPOST")?b.render("premiumjobupload",{udata:a.session.user}):b.send("Access denied",400)});c.post("/index",x,function(a,b){var c="",e=a.param("jobId"),f=a.param("jobState");g.Todo.findById(e,function(b,e){b?console.log(b):(999==f?a.files.additionalFile&&(c=a.files.additionalFile.path,e.additionalFile=l(c)):a.files.workFile&&(c=a.files.workFile.path,e.taskFile=l(c)),e.save(function(b){b?
console.log(b):q(a,"New work posted by employer "+a.session.user.user)}))});b.end()});c.get("/download_work",function(a,b){if(f(a.session.role,"DOWNLOAD_WORKFILE")){var c=require("path").resolve(".")+"/upload/workfiles/"+a.param("workFile");b.download(c,a.param("workFile"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download_supportingdoc",function(a,b){if(f(a.session.role,"DOWNLOAD_SUPPORTINGDOC")){var c=__dirname+"/data/"+a.param("fileName");b.download(c,a.param("fileName"),
function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download_resume",function(a,b){if(f(a.session.role,"DOWNLOAD_RESUME")){var c=require("path").resolve(".")+"/upload/resume/"+a.param("key");b.download(c,a.param("key"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download_report",function(a,b){if(f(a.session.role,"DOWNLOAD_REPORT")){var c=require("path").resolve(".")+"/upload/project/"+a.param("key");b.download(c,a.param("key"),function(a){a&&console.log(a)})}else b.send("Access denied",
400)});c.get("/download_literature",function(a,b){if(f(a.session.role,"DOWNLOAD_LITERATURE")){var c=require("path").resolve(".")+"/upload/literature/"+a.param("key");b.download(c,a.param("key"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/student",function(a,b){c.set("view engine","jade");var d={user:"ExternalUser",email:a.param("user"),contactno:"",country:"",role:"ExternalUser",board:"",standard:"",isActive:!0,isLocked:!1};a.session.user=d;a.session.role=d.role;d="undefined"==
typeof a.param("interest")?"":a.param("interest");g.ExternalUser.update({email:a.param("user")},{$set:{interest:d}},{upsert:!0},function(a,b){a&&console.log(a)});b.render("student",{title:"External Students' Control Panel"})});c.get("/oauth",function(a,b){c.set("view engine","jade");b.render("oauth",{title:"CliqueLearn OAuth"})});c.get("/openresources2",function(a,b){c.set("view engine","jade");b.render("openresources",{title:"Open Resources",interest:a.param("interest")})});c.get("/openresources",
function(a,b){c.set("view engine","jade");if("undefined"===typeof a.param("user"))console.log("not authenticated"),b.redirect("/");else{var d={name:"ExternalUser",email:a.param("user"),contactno:"",country:"",role:"ExternalUser",board:"",standard:"",isActive:!0,isLocked:!1};a.session.user=d;a.session.role=d.role;g.ExternalUser.update({email:a.param("user")},{$set:{interest:a.param("interest")}},{upsert:!0},function(a,b){a&&console.log(a)});b.render("openresources",{title:"Open Resources",interest:a.param("interest")})}});
c.get("/opencm",function(a,b){c.set("view engine","jade");b.render("opencm",{title:"Open Course Materials",interest:a.param("interest")})});c.get("/openassg",function(a,b){c.set("view engine","jade");b.render("openassg",{title:"Open Assignments",interest:a.param("interest")})});c.get("/openquiz",function(a,b){c.set("view engine","jade");b.render("openquiz",{title:"Open Mock Tests",interest:a.param("interest")})});c.get("/openessay",function(a,b){c.set("view engine","jade");b.render("openessay",{title:"Open Writing Skill Development"})});
c.get("/sampleassignment",function(a,b){c.set("view engine","jade");var d=a.param("assgname");"undefined"!==typeof d&&b.render("assignments/"+d)});c.get("/download_paper",function(a,b){if(f(a.session.role,"DOWNLOAD_RESEARCHPAPER")){var c=require("path").resolve(".")+"/upload/research/"+a.param("key");console.log("==>"+c);b.download(c,a.param("key"),function(a){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/",function(a,b){c.set("view engine","jade");b.render("homepage")});c.get("/competitivedoc",
function(a,b){c.set("view engine","jade");b.render("competitivedoc")});c.get("/boarddoc",function(a,b){c.set("view engine","jade");b.render("boarddoc")});c.get("/itdoc",function(a,b){c.set("view engine","jade");b.render("itdoc")});c.get("/cvwriting",function(a,b){c.set("view engine","jade");b.render("cvwriting")});c.get("/counsellingdoc",function(a,b){c.set("view engine","jade");b.render("counsellingdoc")});c.get("/researchdoc",function(a,b){c.set("view engine","jade");b.render("researchdoc")});c.get("/tools",
function(a,b){c.set("view engine","jade");f(a.session.role,"TOOLS")?b.render("tools",{udata:a.session.user,lang:LN}):b.send("Access denied",400)});c.get("/plot",function(a,b){c.set("view engine","ejs");f(a.session.role,"PLOT")?b.render("sketch",{lang:LN}):b.send("Access denied",400)});c.get("/resources",function(a,b){c.set("view engine","jade");f(a.session.role,"RESOURCES")?g.Course.findOne({studyGroup:a.session.user.board+a.session.user.standard},function(c,e){b.render("resources",{udata:a.session.user,
courses:e})}):b.send("Access denied",400)});c.get("/assignCourses",function(a,b){c.set("view engine","jade");f(a.session.role,"ASSIGN_COURSES")?b.render("assignCourses"):b.send("Access denied",400)});c.get("/about",function(a,b){c.set("view engine","jade");b.render("about")});c.get("/contact",function(a,b){c.set("view engine","jade");b.render("contact")});c.get("/freelance",function(a,b){c.set("view engine","jade");b.render("freelance")});c.get("/freshersjob",function(a,b){c.set("view engine","jade");
b.render("freshersjob")});c.get("/locker",h,function(a,b){null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):f(a.session.role,"LOCKER")?g.LockerStore.aggregate([{$match:{userId:a.session.user.user}},{$group:{_id:null,sum:{$sum:"$size"}}}],function(a,c){if(a)throw a;c[0]?b.render("locker",{totalSizeLoaded:c[0].sum.toFixed(3)}):b.render("locker",{totalSizeLoaded:0})}):b.send("Access denied",400)});c.get("/retrieve",h,function(a,b){c.set("view engine","jade");null==a.session.user?
b.redirect("/signin"):f(a.session.role,"RETRIEVE")?b.render("retrieve"):b.send("Access denied",400)});c.post("/locker",h,function(a,b){var d=a.files.myFile.name;null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):(g.LockerStore.update({$and:[{userId:a.session.user.user},{fileName:d}]},{$set:{key:D(a.files.myFile.path),size:a.param("size")}},{upsert:!0},function(a,b){a&&console.log(a)}),b.end())});c.post("/premiumjobupload",y,function(a,b){null==a.session.user?console.log("User not logged in"):
(null!=a.files&&(new g.PremiumJobStore({userId:a.session.user.user,fileType:a.param("fileType"),fileName:l(a.files.myAdvFile.path)})).save(),b.end())});c.get("/blogController/posts",blogController.posts);c.get("/blogController/post/:id",blogController.post);c.post("/blogController/post",blogController.addPost);c.put("/blogController/post/:id",blogController.editPost);c.delete("/blogController/post/:id",blogController.deletePost);c.get("/topicController/Topics",topicController.Topics);c.get("/topicController/Topic/:id",
topicController.Topic);c.post("/topicController/Topic",topicController.addTopic);c.put("/topicController/Topic/:id",topicController.editTopic);c.delete("/topicController/Topic/:id",topicController.deleteTopic);c.get("/feedbackController/Feedbacks",feedbackController.Feedbacks);c.get("/feedbackController/Feedback/:id",feedbackController.Feedback);c.put("/feedbackController/Feedback/:id",feedbackController.editFeedback);c.delete("/feedbackController/Feedback/:id",feedbackController.deleteFeedback);
c.get("/blogController/viewblogs",blogController.posts);c.get("/accountController/Account",function(a,b){AM.getAllRecords(function(a,c){return b.json(c)})});c.get("/accountController/Account/:id",function(a,b){AM.getRecord(a.params.id,function(a,c){a?b.json({status:!1}):b.json({Account:c,status:!0})})});c.put("/accountController/Account/:id",h,function(a,b){void 0!=a.param("user")&&AM.updateAccount({name:a.param("name"),email:a.param("email"),contactno:a.param("contactno"),role:a.param("role"),country:a.param("country"),
board:a.param("board"),standard:a.param("standard"),user:a.param("user"),pass:a.param("pass")},function(a,c){a?b.json(!1):b.json(!0)})});c.delete("/accountController/Account/:id",h,function(a,b){var c=a.params.id;c&&AM.deleteAccount(c,function(a,c){a?b.json(!1):b.json(!0)})});c.get("/accountController/*",function(a,b){b.send(404)});c.get("/blogController/*",function(a,b){b.send(404)});c.get("/partials/:name",index._partials);c.get("/partials/*",index.partials);c.get("/blog",index.blog);c.get("/viewblogs",
index.viewblog);c.get("/userAdmin",index.userAdmin);c.get("/essayTopicAdmin",index.essayTopicAdmin);c.get("/feedbackAdmin",index.feedbackAdmin);c.get("/chatController/*",function(a,b){b.send(404)});c.get("/quiz",h,function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"QUIZ")?"undefined"!=typeof a.param("_id")?g.SessionData.findOne({_id:a.param("_id")},function(c,e){null!=e&&b.render("quizSession",{title:"Quiz",udata:a.session.user,subject:e.subject,
testname:e.testname,sessionId:e.sessionId,elapsedTime:e.elapsedTime,ansJson:e.ansJson,doubtJson:e.doubtJson})}):b.render("quiz",{title:"Quiz",udata:a.session.user,subject:a.param("subject"),testname:a.param("testname")}):b.send("Access denied",400)});c.get("/externalUsers",function(a,b){c.set("view engine","jade");b.render("ViewExternalUsers")});c.post("/lservices",h,function(a,b){var d="";null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):"true"==a.param("logout")?m(a,b):f(a.session.role,
"LEARNING_SERVICES")?(void 0!=a.body.academicQuestion&&(d=a.body.academicQuestion.trim()),""!=d&&(new g.AcademicQuestion({userId:a.session.user.user,academicQuestion:d,answer:""})).save()):b.send("Access denied",400)});c.post("/eservices",h,function(a,b){var d="";null==a.session.user?(c.set("view engine","jade"),b.redirect("/signin")):"true"==a.param("logout")?m(a,b):f(a.session.role,"EARNING_SERVICES")?(void 0!=a.body.counsel_query&&(d=a.body.counsel_query.trim()),""!=d&&(new g.CareerCounselling({userId:a.session.user.user,
counselQuery:d,reply:""})).save()):b.send("Access denied",400)});c.post("/writeEssay",function(a,b){if(a.session.user==a.null)c.set("view engine","jade"),b.redirect("/signin");else{var d="",e="";void 0!=a.body.essaycaption&&void 0!=a.body.essaytxt&&(d=a.body.essaycaption.trim(),e=a.body.essaytxt.replace(/  /g," "),e=e.replace(/\t/g," "),e=e.replace(/\n/g,""));""!=d&&""!=e&&(new g.Essay({userId:a.session.user.user,essayCaption:d,essayText:e,isEval:!1})).save(function(b,c){b?console.log(b):(g.Essay.update({_id:c._id},
{$set:{isEval:!1,expert_score_set:{correctness_of_fact_score:0,grammar_score:0,sentence_constuction_score:0,depth_of_explanation_score:0,clarity_of_thoughts_score:0,choice_of_words_score:0,style_score:0}}},{upsert:!1},function(a,b){a&&console.log(a)}),g.SessionData.remove({sessionId:a.body.sessionId},function(a){a&&console.log(a)}))})}});c.post("/autosave",function(a,b){g.SessionData.update({$and:[{userId:a.session.user.user},{sessionId:a.body.sessionId}]},{$set:{elapsedTime:a.body.elapsedTime,essaycaption:a.body.essaycaption,
essaytxt:a.body.essaytxt}},{upsert:!0},function(a,b){a&&console.log(a)})});c.post("/autosave2",function(a,b){null!=a.session.user&&g.SessionData.findOne({$and:[{userId:a.session.user.user},{sessionId:a.body.sessionId}]},function(b,c){b||(c?c.elapsedTime>a.body.elapsedTime&&(c.elapsedTime=a.body.elapsedTime,c.subject=a.body.subject,c.testname=a.body.testname,c.ansJson=a.body.ansJson,c.doubtJson=a.body.doubtJson,c.save(function(a){a&&console.log(a)})):g.SessionData.update({$and:[{userId:a.session.user.user},
{sessionId:a.body.sessionId}]},{$set:{elapsedTime:a.body.elapsedTime,subject:a.body.subject,testname:a.body.testname,ansJson:a.body.ansJson,doubtJson:a.body.doubtJson}},{upsert:!0},function(a,b){a&&console.log(a)}))})});c.get("/scoreessays",function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"SCORE_ESSAYS")?g.Essay.find({isEval:!1},function(a,c){b.render("scoreessays",{title:"Score Essays",essayDetails:c})}):b.send("Access denied",400)});c.get("/essayscores",
function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"VIEW_ESSAY_SCORES")?g.Essay.find({userId:a.session.user.user},function(a,c){b.render("viewessayscores",{title:"View Essay Scores",essayDetails:c})}):b.send("Access denied",400)});c.get("/pdfkit",function(a,b){c.set("view engine","ejs");null==a.session.user?b.redirect("/signin"):f(a.session.role,"PDFKIT")?b.render("pdfkit"):b.send("Access denied",400)});c.get("/codeedit",function(a,b){c.set("view engine",
"ejs");null==a.session.user?b.redirect("/signin"):f(a.session.role,"CODEEDIT")?b.render("codeedit",{lang:a.param("lang")}):b.send("Access denied",400)});c.post("/retrieve",h,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else{var d=a.body.myFile;if("undefined"!=typeof d){var e="";-1!=d.lastIndexOf(".")&&(e=d.substring(d.lastIndexOf("."),d.len));g.LockerStore.findOne({$and:[{userId:a.session.user.user},{fileName:d}]},function(a,c){if(!a)if(c){var d=c.key+e,
d=require("path").resolve(".")+"/upload/locker/"+d;b.download(d,function(a){a&&console.log(a)})}else console.log("No record found!")})}}});c.get("/associateRoles",function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"ASSOCIATE_ROLE")?b.render("associateRoles",{title:"Associate Role with Functionality",roleMap:roleMap}):b.send("Access denied",400)});c.post("/associateRoles",function(a,b){var c=a.param("rolename"),e=a.param("unit_func_list");RL.push({"short":"**",
name:c,unit_function:e})});c.get("/createTest",function(a,b){c.set("view engine","jade");null==a.session.user?b.redirect("/signin"):f(a.session.role,"CREATE_TEST")?b.render("createTest",{title:"Configure A Mock Test",udata:a.session.user}):b.send("Access denied",400)});c.post("/postImage",z,function(a,b){b.writeHead(200,a.files.qImageFile.path);b.end()});c.get("/selectedImage",function(a,b){var c=a.param("imageFile");b.sendfile(c)});c.post("/createTest",h,function(a,b){var c=a.param("qp"),e=a.param("testname");
fs.writeFile(__dirname+"/../../lib/"+e+".json",c,function(a){if(a)return console.log(a);console.log("The file"+e+".json was saved!")})});c.post("/viewregistration",function(a,b){if(f(a.session.role,"VIEW_REGISTRATION")){var c=a.param("id"),e=a.param("approvalStatus");g.Registration.update({_id:c},{$set:{approvalStatus:e}},{upsert:!0},function(a,b){a&&console.log(a)})}else b.send("Access denied",400)});c.get("/download",h,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");
else if(f(a.session.role,"DOWNLOAD_LIBRARY_BOOKS")){require("path");var d=__dirname+"/Resources/Books/"+a.param("fileName");b.download(d,function(a){a&&console.log("Error downloading file from library")})}else b.send("Access denied",400)});c.get("/download_assg",u,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if(f(a.session.role,"DOWNLOAD_ASSIGNMENT")){require("path");var d=__dirname+"/Resources/Assignments/"+a.param("fileName");b.download(d,function(a){a&&
console.log("Error downloading file from library: "+a)})}else b.send("Access denied",400)});c.get("/download_assgsol",v,function(a,b){if(null==a.session.user)c.set("view engine","jade"),b.redirect("/signin");else if(f(a.session.role,"DOWNLOAD_ASSIGNMENT_SOLUTION")){var d=require("path"),e=__dirname+"/../../upload/assignmentsoln/"+a.param("fileName");b.download(d.resolve(e),function(a){a&&console.log("Error downloading file from assignment store: "+a)})}else b.send("Access denied",400)});c.get("/robots.txt",
h,function(a,b){fs.readFile(__dirname+"/../../robots.txt",function(a,c){b.end(c)})});c.get("*",function(a,b){c.set("view engine","jade");b.render("404",{title:"Page Not Found"})});var m=function(a,b){b.clearCookie("user");b.clearCookie("pass");b.clearCookie("role");a.session.destroy(function(a){b.send("ok",200)})},D=function(a){a=a.replace(/\\/g,"/").replace(/.*\//,"");-1!=a.lastIndexOf(".")&&(a=a.substring(0,a.lastIndexOf(".")));return a},l=function(a){return a.replace(/\\/g,"/").replace(/.*\//,
"")},f=function(a,b){var c=-1;console.log("RESOURCE:"+b);var e=Object.keys(RL),f;for(f in e)RL[f].name==a&&(c=f);if(0<=c)for(e=0;e<RL[c].unit_function.length;e++)if(b==RL[c].unit_function[e])return!0;return!1},B=function(a){var b=os.networkInterfaces();Object.keys(b).forEach(function(c){b[c].forEach(function(b){if("IPv4"!==b.family||!1!==b.internal)return"";null!=a.session.user&&(console.log(c,b.address),(new g.LoginRecord({userId:a.session.user.user,interfaceName:c+":0",ipAddress:b.address})).save())})})},
q=function(a,b){if(null!=a.session.user){var c={from:"CliqueLearn Admin <admin@cliquelearn.org>",to:[a.session.user.email,"admin@cliquelearn.org"],subject:"Notification from CliqueLearn",text:b};mailgun.messages().send(c,function(a,b){console.log(b)})}else c={from:"CliqueLearn Admin <admin@cliquelearn.org>",to:"admin@cliquelearn.org",subject:"Notification from CliqueLearn",text:b},mailgun.messages().send(c,function(a,b){console.log(b)})}};
